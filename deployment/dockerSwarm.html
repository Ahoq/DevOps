<!-- Temperory fix using inline styles, pending to contact UX team on this issue, list elements enlarge for every indent-->
<!DOCTYPE html>
<html>
<!-- THIS FILE WAS GENERATED BY A SCRIPT: DO NOT EDIT IT! -->
  <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="../style.css">

        <!-- jQuery CDN -->
         <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
         <!-- Bootstrap Js CDN -->
         <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

         <script type="text/javascript">
             var status = 'on';
             $(document).ready(function () {
                 $('#sidebarCollapse').on('click', function () {
                     $('#sidebar').toggleClass('active');
                     if (status == 'on') {
                         $('#sidebarText').text("Expand Side Nav");
                         status = 'off';
                     } else {
                         $('#sidebarText').text("Collapse Side Nav");
                         status = 'on';
                     }
                 });
             });
         </script>
    <title>
    dockerSwarm
    </title>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-114841175-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-114841175-1');
</script>
  </head>
  <body>
    <div class="wrapper">
<!-- Sidebar Holder -->
<nav id="sidebar">
    <div id="sidebarCollapse">
        <div class="sidebar-header">
            <h1>DevOps</h1>
            <strong>DO</strong>
        </div>
    </div>

    <ul class="list-unstyled components">
        <li>
            <a href="https://gcallah.github.io/DevOps/index.html">
                <i class="glyphicon glyphicon-home"></i>
                Home
            </a>
        </li>
        <li>
            <a href="#pageSubmenu" data-toggle="collapse" aria-expanded="false">
                <i class="glyphicon glyphicon-duplicate"></i>
                Main Areas of Coverage
            </a>
            <ul class="collapse list-unstyled" id="pageSubmenu">
                <li>
                  <a href="#BuildSubmenu" data-toggle="collapse" aria-expanded="false">Build</a>
                  <ul class="collapse list-unstyled" id="BuildSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/build/links.html">Build links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/build/theory.html">Build theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/build/tools.html">Build tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/build/implementation.html">Our build implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#CloudSubmenu" data-toggle="collapse" aria-expanded="false">Cloud</a>
                  <ul class="collapse list-unstyled" id="CloudSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/cloud/links.html">Cloud links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/cloud/theory.html">Cloud theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/cloud/tools.html">Cloud tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/cloud/implementation.html">Our cloud implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#CodingSubmenu" data-toggle="collapse" aria-expanded="false">Coding: Lean and Agile Practices</a>
                  <ul class="collapse list-unstyled" id="CodingSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/coding/links.html">Coding links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/coding/theory.html">Coding theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/coding/tools.html">Coding tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/coding/implementation.html">Our coding implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#DeploySubmenu" data-toggle="collapse" aria-expanded="false">Deployment</a>
                  <ul class="collapse list-unstyled" id="DeploySubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/deployment/links.html">Deployment links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/deployment/theory.html">Deployment theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/deployment/tools.html">Deployment tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/deployment/implementation.html">Our deployment implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#MonitorSubmenu" data-toggle="collapse" aria-expanded="false">Monitoring</a>
                  <ul class="collapse list-unstyled" id="MonitorSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/monitoring/links.html">Monitoring links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/monitoring/theory.html">Monitoring theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/monitoring/tools.html">Monitoring tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/monitoring/implementation.html">Our monitoring implementation </a></li>
                  </ul>
                </li>
                <li>
                  <a href="#SecuritySubmenu" data-toggle="collapse" aria-expanded="false">Security: Rugged DevOps</a>
                  <ul class="collapse list-unstyled" id="SecuritySubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/security/links.html">Security links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/security/theory.html">Security theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/security/tools.html">Security tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/security/implementation.html">Our security implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#TestingSubmenu" data-toggle="collapse" aria-expanded="false">Testing</a>
                  <ul class="collapse list-unstyled" id="TestingSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/testing/links.html">Testing links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/testing/theory.html">Testing theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/testing/tools.html">Testing tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/testing/implementation.html">Our testing implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#WorkflowSubmenu" data-toggle="collapse" aria-expanded="false">Workflow: DevOps as a Way of Work</a>
                  <ul class="collapse list-unstyled" id="WorkflowSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/workflow/links.html">Workflow links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/workflow/theory.html">Workflow theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/workflow/tools.html">Workflow tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/workflow/implementation.html">Our workflow implementation</a></li>
                  </ul>
                </li>
                <li>
                  <a href="#UXSubmenu" data-toggle="collapse" aria-expanded="false">UX: User Interface</a>
                  <ul class="collapse list-unstyled" id="UXSubmenu">
                    <li><a href="https://gcallah.github.io/DevOps/UX/links.html">UX links</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/UX/theory.html">UX theory</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/UX/tools.html">UX tools</a></li>
                    <li><a href="https://gcallah.github.io/DevOps/UX/implementation.html">Our UX implementation</a></li>
                  </ul>
                </li>
            </ul>
        </li>
        <li>
            <a href="#MaterialsSubmenu" data-toggle="collapse" aria-expanded="false">
                <i class="glyphicon glyphicon-link"></i>
                Other Materials
            </a>
            <ul class="collapse list-unstyled" id="MaterialsSubmenu">
              <li>
                <a href="#CMSubmenu" data-toggle="collapse" aria-expanded="false">Course-specific Material</a>
                <ul class="collapse list-unstyled" id="CMSubmenu">
                  <li><a href="https://gcallah.github.io/DevOps/courseDescr.html">Course description, Spring 2018</a></li>
                  <li><a href="https://gcallah.github.io/DevOps/courseExpectations.html">Course expectations, Spring 2018</a></li>
                  <li><a href="https://gcallah.github.io/DevOps/TeamsTable.html">Our teams for Spring 2018</a></li>
                  <li><a href="https://gcallah.github.io/DevOps/books.html">DevOps reading list</a></li>
                  <li><a href="https://gcallah.github.io/DevOps/journals/index.html">Our DevOps journals</a></li>
                  <li>
                  <a href="http://www.thedevopscourse.com/quiz/">Our Django
                  site: we are creating a quiz system here.</a>
                  </li>
                  <li>
                    <a href="https://gcallah.pythonanywhere.com/berkeley/">
                        DevOps Bibliographic Search
                    </a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#SupSubmenu" data-toggle="collapse" aria-expanded="false">Supplementary Material</a>
                <ul class="collapse list-unstyled" id="SupSubmenu">
                  <li><a href="https://gcallah.github.io/DevOps/websites.html">DevOps websites</a></li>
                </ul>
              </li>
            </ul>
        </li>
        <li>
            <a href="https://gcallah.github.io/DevOps/about.html">
                <i class="glyphicon glyphicon-briefcase"></i>
                About
            </a>
        </li>
    </ul>
</nav>
    <div id="content">

    <h1>
      Deployment with Clusters
    </h1>
    <p>Deployment of an application in a container over a number 
      of machines with replicas to scale the applications as well 
      as recover from failures is the principle concept of cluster 
      deployment.Such kind of deployment provision requires an
      automation infrastrucure to create, manage, maintain the clusters.
      Prominent cluster deployment and tools we will be looking at are,
    </p>
    <ol>
      <li><strong>Docker Swarm</strong></li>
      <li><strong>Kubernetes</strong></li>
    </ol>
    <h3>
    1. Docker Swarm
    </h3>
    <p>
      <img src="https://raw.githubusercontent.com/docker-library/docs/471fa6e4cb58062ccbf91afc111980f9c7004981/swarm/logo.png">
    </p>
    <p>A swarm is a group of machines running docker tied togther 
      to form a cluster managed by a swarm manager. Once a cluster is
      created, all the machines tied together are referred to as 
      nodes/workers. 
      Only the swarm manager machine has authorization to execute commands
      or add more workers.
    </p>
    <ul>
      <li><strong>Swarm Manager</strong></li>
      <li><strong>Worker or Node</strong></li>
    </ul>
    <h5>Example of a Docker Swarm Deployment</h5>
    <p>
    Lets look at a demonstration of a cluster deployment using docker swarm
    </p>
    <h5>-- Aim:</h5>
    <ul>
      <li>To deploy the static webpage in a cluster with multiple 
        instances using docker swarm
        <ul>
          <li ><p><b>Cluster/Nodes:</b> Group of virtual machines</p></li>
          <li><p><b>Application:</b> devOps wesite served as static web pages</p></li>
          <li><p><b>Tool Used:</b> Docker swarm</p></li>
        </ul>
      </li>
    </ul>
      <h5>-- Components:</h5>
    <ul>
      <li><strong>Swarm Manager -</strong> Assuming the local machine &lt;machine 
          you are using&gt; or one of the cirtual machine to be the manager</li>
      <li><strong>devOps website as a container -</strong>
    <ul>
      <li><strong>Dockerfile -</strong> Using standalone nginx container 
          and serving the static webpages from source</li>
      <li><strong>DockerCompose -</strong> Using a combination of multiple containers
          of nginx &lt;to host the website&gt; + git-sync &lt;to sync with the 
          repository&gt; + common container storage</li>
      <li> while in this context, lets take a detour to briefly look at  
          <em>dockerFile vs dockerCompose</em>
    <ul>
      <li><strong>dockerFile:</strong><br>
        When a self-contained container or monolithic container 
        image is to be created which suffices the functionality 
        within itself, a docker file is used<br>
        <img src="https://i.stack.imgur.com/jc2IW.jpg" title="dockerFile">
      </li>
    <li>
      <strong>dockerCompose:</strong><br>
      When multiple containers are required which together suffice a 
      functionlity as a team, docker compose is used<br>
      <img src="https://raw.githubusercontent.com/docker/compose/master/logo.png" title="dockeCompose"></li>
      </ul>
    </li>
    </ul>
    </li>
      <li><strong>Virutal machines -</strong> 
      either remote cloud machines or local setup of vms using virutalBox</li>
      <li><strong>Setup Concern -</strong> 
        Due to cloud machine availability, lets resort to a local setup for 
        the example and peek into an instance of cloud deployment as well.</li>
    </ul>
      <h5>-- Installation:</h5>
    <ul>
      <li>Ensure docker is installed</li>
        <li>Possess any virtual machine setup provision using virtualbox or
         vmware workstation or make cloud machines setup</li>
    </ul>
        <h5>-- Setup:</h5>
    <ul>
        <li><strong>TestBed 1:</strong> As per instructions in docker page,
         use a nginx container to host the website source code while running
          docker instance</li>
    </ul>
      <pre>
        <code>
          <span>
          # Pull the nginx docker image from register =&gt; docker pull nginx

          $ docker run --name devops_website -p 127.0.0.1:8080:80 -v &lt; location of website sourcecode &gt;:/usr/share/nginx/html -d nginx
          </span>
        </code>
      </pre>
      <ul>
      <li>
        <strong>TestBed 2:</strong> 
        Use the dockerCompose file below which uses,
      <ul>
        <li><em>Two containers:</em>
        <ul>
          <li>nginx - to host the website</li>
          <li>git-sync - to sync with the git repo for new changes</li>
        </ul>
        </li>
        <li><em>Storage</em> - a common datastore to hold the website source code</li>
      </ul>
      </li>
      </ul>
      <pre>
        <code> 
          # A Docker compose to create the application with two containers
          # * 1. Nginx container
          # * 2. git-sync container
          # Reference from: https://hub.docker.com/r/openweb/git-sync/
          # Run with `docker-compose up -d` once the dockerCompose 
          file is created 
          version: "2"
            services:
              nginx:
                image: nginx:latest
                ports:
                  - "8080:80"
                volumes:
                  - website_sources:/usr/share/nginx/html:z
                depends_on:
                  - git-sync
                restart: always
              git-sync:
                image: openweb/git-sync:0.0.1
                environment:
                  GIT_SYNC_REPO: "https://github.com/gcallah/DevOps"
                  GIT_SYNC_DEST: "/git"
                  GIT_SYNC_BRANCH: "master"
                  GIT_SYNC_REV: "FETCH_HEAD"
                  GIT_SYNC_WAIT: "10"
                volumes:
                  - website_sources:/git:z
                restart: always
            volumes:
              website_sources:
            driver: local
        </code>
        </pre>
        <h5>Steps for Usage:</h5>
        <ul>
        <li> Use docker-machine command line to use the virtual box 
          driver and create virtual machines for the cluster. For the 
          demo, lets create three virtual machines. One being the master 
          and the other two workers. Use the following command to perform
           the required operation
        <pre>
        <code>
          <span>
          docker-machine create --driver virtualbox myvm1
          docker-machine create --driver virtualbox myvm2
          docker-machine create --driver virtualbox myvm3
          </span>
        </code>
      </pre>
      <p>Command line output sample:</p>
      <pre>
      <code>
         <span>
          <b>MacBook-Pro:devOps deployment$ docker-machine create --driver virtualbox myvm1</b>
          Running pre-create checks...
          Creating machine...
          (myvm1) Copying /Users/darkknight/.docker/machine/cache/boot2docker.iso to /Users/darkknight/.docker/machine/machines/myvm1/boot2docker.iso...
          (myvm1) Creating VirtualBox VM...
          (myvm1) Creating SSH key...
          (myvm1) Starting the VM...
          (myvm1) Check network to re-create if needed...
          (myvm1) Waiting for an IP...
          Waiting for machine to be running, this may take a few minutes...
          Detecting operating system of created instance...
          Waiting for SSH to be available...
          Detecting the provisioner...
          Provisioning with boot2docker...
          Copying certs to the local machine directory...
          Copying certs to the remote machine...
          Setting Docker configuration on the remote daemon...
          Checking connection to Docker...
          Docker is up and running!
         </span>
      </code>
    </pre>
    </li>
    <li> List the virtual machines to look at the created vms.
      <pre>
        <code>
          <span>
          docker-machine ls
          </span>
        </code>
      </pre>
      <p>Command line output sample:</p>
      <pre>
      <code>
         <span>
          <b>MacBook-Pro:devOps deployment$ docker-machine ls</b>
          NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS     
          myvm1     -        virtualbox   Running   tcp://192.168.99.100:2376           v18.03.1-ce   
          myvm2     -        virtualbox   Running   tcp://192.168.99.101:2376           v18.03.1-ce   
          myvm3     -        virtualbox   Running   tcp://192.168.99.102:2376           v18.03.1-ce  
         </span>
      </code>
    </pre>
    </li>
        <li> The virtual machines can be connected using ssh to execute 
          commands and make proper swarm setup. Consider the "vm1" 
          machine as the master. Initiating the swarm from node1 "vm1" 
          would make the current node as master
      <pre>
        <code>
          <span>
          docker-machine ssh myvm1 "docker swarm init --advertise-addr &ltmyvm1 ip&gt" 
          </span>
        </code>
      </pre>
      <p>Command line output sample:</p>
      <pre>
      <code>
         <span>
          <b>MacBook-Pro:devOps deployment$ docker-machine ssh myvm1 "docker swarm init --advertise-addr 192.168.99.100"</b>
          Swarm initialized: current node (lhys3d8lpqc1onnikx5t9jaep) is now a manager.

          To add a worker to this swarm, run the following command:

          docker swarm join --token SWMTKN-1-0u40ts3aguqoa4jmt7rmrxh1gpkujs2fahhdmi55uz0eum3bxi-cwaxy2whk4pq2sxpg0g7prao0 192.168.99.100:2377

          To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
         </span>
      </code>
    </pre>
    </li> 
      <li> Next, the worker nodes have to configured such that
       they recognize the swarm configuration and know the master. 
       Make sure to use the token and ip of the master node 
       generated when swarm was initialized
      <pre>
        <code>
          <span>
          docker-machine ssh myvm2 "docker swarm join --token &lttoken&gt &ltip&gt:2377"
          </span>
        </code>
      </pre>
      <p>Command line output sample:</p>
      <pre>
      <code>
         <span>
          <b>MacBook-Pro:devOps deployment$ docker-machine ssh myvm2 "docker swarm join --token SWMTKN-1-0u40ts3aguqoa4jmt7rmrxh1gpkujs2fahhdmi55uz0eum3bxi-cwaxy2whk4pq2sxpg0g7prao0 192.168.99.100:2377"</b>
          This node joined a swarm as a worker.
         </span>
      </code>
    </pre>
    </li> 
    </ul>
    <ul>
      <h4>References and Source:</h4>
      <li>Image from https://raw.githubusercontent.com/docker-library/</li>
      <li>Image from https://raw.githubusercontent.com/docker/compose/master/logo.png</li>
      <li>Image from https://i.stack.imgur.com/jc2IW.jpg</li>
      <li>Docker compose reference at https://hub.docker.com/r/openweb/git-sync/</li>
      <li>Docker Swarm - https://docs.docker.com/get-started/part4/#configure-a-docker-machine-shell-to-the-swarm-manager</li>
    </ul>
      </div>
    </div>
    </body>
</html>
